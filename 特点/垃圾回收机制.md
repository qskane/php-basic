# 垃圾回收机制

## 引用计数基本知识

- 每个php变量存在一个叫"zval"的变量容器中。
- 每个zval变量容器包含：变量类型，变量值，is_ref(是否为使用&引用变量)，refcount(指向该容器的变量个数)
- 数组或对象中的元素循环引用，当外层变量被unset后，就无法再减少内部refcount数导致内存泄漏。

## 回收周期
鉴于上诉中内存泄漏的情况，PHP5.3 使用回收周期算法来识别此类垃圾。

1. 所有可能根放在根缓冲区（默认10000个上限）标记为疑似垃圾，缓冲区满后执行垃圾回收操作。
2. 模拟删除每个可能根，若导致普通变量refcount计数减少为0，则继续对该普通变量模拟删除，直到遍历完所有影响方。
3. 对模拟删除后refcount >= 0 的变量执行模拟恢复。
4. 对模拟删除后refcount = 0 的变量执行真实删除操作。

## 性能方面考虑的因素

PHP 5.3中对 PHP run-time进行了修改，减少了记录可能根带来的性能损失。执行垃圾回收势必会增加运行时间，节省内存消耗。
- 内存占用空间的节省
- 垃圾回收机制执行内存清理时的执行时间增加